var Kckr,fs,helpers,path,wait,__bind=function(fn,me){return function(){return fn.apply(me,arguments)}};fs=require("fs"),path=require("path"),helpers=require("./helpers"),wait=function(milliseconds,func){return setTimeout(func,milliseconds)},Kckr=function(){function Kckr(options){this.remove_source=__bind(this.remove_source,this),this.unwatch_dir=__bind(this.unwatch_dir,this),this.watch_dir=__bind(this.watch_dir,this),this.watch=__bind(this.watch,this),this.kickoff=__bind(this.kickoff,this),this.validate=__bind(this.validate,this);var defaults,source,_i,_len,_ref;options||(options={}),defaults={pattern:/.*/,sources:[],callback:function(){},verbose:!1,kickonce:!1},options=helpers.merge(defaults,options),this.sources=options.sources,this.not_sources=[],this.fn=options.callback,this.re=options.pattern,this.verbose=options.verbose,this.kickonce=options.kickonce,_ref=this.sources;for(_i=0,_len=_ref.length;_i<_len;_i++)source=_ref[_i],this.kickoff(source,!0,path.normalize(source),!0)}return Kckr.prototype.validate=function(source){return!!source.match(this.re)},Kckr.prototype.kickoff=function(source,top_level,base,first_run){var _this=this;return first_run==null&&(first_run=!1),fs.stat(source,function(err,stats){if(err&&err.code!=="ENOENT")throw err;if((err!=null?err.code:void 0)==="ENOENT")return;if(stats.isDirectory())return _this.kickonce||_this.watch_dir(source,base),first_run&&_this.verbose&&console.log("Watching dir: "+source),fs.readdir(source,function(err,files){var file,index,_i,_len,_results;if(err&&err.code!=="ENOENT")throw err;if((err!=null?err.code:void 0)==="ENOENT")return;files=files.map(function(file){return path.join(source,file)}),index=_this.sources.indexOf(source),[].splice.apply(_this.sources,[index,index-index+1].concat(files)),files,_results=[];for(_i=0,_len=files.length;_i<_len;_i++)file=files[_i],_results.push(_this.kickoff(file,!1,base,!0));return _results});if(!(top_level||stats.isFile()&&_this.validate(source)))return _this.not_sources[source]=!0,_this.remove_source(source,base);_this.kickonce||_this.watch(source,base),_this.kickonce&&_this.fn(source,base);if(first_run&&_this.verbose)return console.log("Watching file: "+source)})},Kckr.prototype.watch=function(source,base){var execute,rewatch,watchOpts,watch_err,_this=this;watchOpts={persistent:!1,interval:25},watch_err=function(e){if(e.code!=="ENOENT")throw e;if(_this.sources.indexOf(source)===-1)return;try{return rewatch()}catch(e){return _this.remove_source(source,base,!0)}},execute=function(curr,prev){if(curr.mtime>prev.mtime)return _this.fn(source,base),rewatch()};try{fs.watchFile(source,watchOpts,execute)}catch(e){watch_err(e)}return rewatch=function(){return fs.unwatchFile(source),fs.watchFile(source,watchOpts,execute)}},Kckr.prototype.watch_dir=function(source,base){var readdir_timeout,watcher,_this=this;readdir_timeout=null;try{return watcher=fs.watch(source,function(){return clearTimeout(readdir_timeout),readdir_timeout=wait(25,function(){return fs.readdir(source,function(err,files){var file,_i,_len,_results;if(err){if(err.code!=="ENOENT")throw err;return watcher.close(),_this.unwatch_dir(source,base)}files=files.map(function(file){return path.join(source,file)}),_results=[];for(_i=0,_len=files.length;_i<_len;_i++){file=files[_i];if(_this.sources.some(function(s){return s.indexOf(file)>=0}))continue;_this.sources.push(file),_results.push(_this.kickoff(file,!1,base))}return _results})})})}catch(e){if(e.code!=="ENOENT")throw e}},Kckr.prototype.unwatch_dir=function(source,base){var file,prev_sources,to_remove,_i,_len,_this=this;prev_sources=this.sources.slice(0,this.sources.length),to_remove=function(){var _i,_len,_ref,_results;_ref=this.sources,_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++)file=_ref[_i],file.indexOf(source)>=0&&_results.push(file);return _results}.call(this);for(_i=0,_len=to_remove.length;_i<_len;_i++)file=to_remove[_i],remove_source(file,base,!0);!this.sources.some(function(s,i){return prev_sources[i]!==s})},Kckr.prototype.remove_source=function(source,base){var index;return index=this.sources.indexOf(source),this.sources.splice(index,1)},Kckr}(),exports.Kckr=Kckr;